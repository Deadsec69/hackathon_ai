<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Agent Admin Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>AI Agent Admin Dashboard</h1>

        <!-- System Status -->
        <div class="card">
            <h2>System Status</h2>
            <div id="status-metrics" class="dashboard">
                <!-- Will be populated by JavaScript -->
            </div>
            <button class="button refresh-button" onclick="refreshMetrics()">Refresh</button>
        </div>

        <!-- Simulation Controls -->
        <div class="card">
            <h2>Simulation Controls</h2>
            <div class="controls">
                <div>
                    <h3>CPU Load</h3>
                    <div class="slider-container">
                        <input type="range" min="0" max="100" value="10" class="slider" id="cpuSlider">
                        <div class="slider-value" id="cpuValue">10%</div>
                    </div>
                    <button class="button warning" onclick="simulateCPU()">Simulate CPU Load</button>
                </div>
                <div>
                    <h3>Memory Usage</h3>
                    <div class="slider-container">
                        <input type="range" min="0" max="200" value="50" class="slider" id="memorySlider">
                        <div class="slider-value" id="memoryValue">50MB</div>
                    </div>
                    <button class="button warning" onclick="simulateMemory()">Simulate Memory Load</button>
                </div>
            </div>
            <button class="button success" onclick="fixIssues()">Fix All Issues</button>
        </div>

        <!-- Incident History -->
        <div class="card">
            <h2>Incident History</h2>
            <div id="incidents" class="history">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Restart History -->
        <div class="card">
            <h2>Restart History</h2>
            <div id="restarts" class="history">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Update sliders
        const cpuSlider = document.getElementById('cpuSlider');
        const cpuValue = document.getElementById('cpuValue');
        const memorySlider = document.getElementById('memorySlider');
        const memoryValue = document.getElementById('memoryValue');

        cpuSlider.oninput = function() {
            cpuValue.textContent = this.value + '%';
        }

        memorySlider.oninput = function() {
            memoryValue.textContent = this.value + 'MB';
        }

        // Simulation functions
        async function simulateCPU() {
            const cpuLoad = cpuSlider.value / 100;
            const response = await fetch(`/simulate/cpu/${cpuLoad}`);
            const data = await response.json();
            refreshMetrics();
        }

        async function simulateMemory() {
            const memoryMB = memorySlider.value;
            const response = await fetch(`/simulate/memory/${memoryMB}`);
            const data = await response.json();
            refreshMetrics();
        }

        async function fixIssues() {
            const response = await fetch('/fix_issues');
            const data = await response.json();
            refreshMetrics();
        }

        // Refresh metrics
        async function refreshMetrics() {
            // Get metrics
            const metricsResponse = await fetch('/metrics');
            const metrics = await metricsResponse.json();

            // Get status
            const statusResponse = await fetch('/status');
            const status = await statusResponse.json();

            // Update metrics display
            const statusMetrics = document.getElementById('status-metrics');
            statusMetrics.innerHTML = `
                <div class="metric">
                    <span class="metric-label">CPU Usage</span>
                    <span class="metric-value ${metrics.cpu_usage > 0.8 ? 'danger' : metrics.cpu_usage > 0.5 ? 'warning' : 'success'}">${(metrics.cpu_usage * 100).toFixed(1)}%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Memory Usage</span>
                    <span class="metric-value ${metrics.memory_usage > 90 ? 'danger' : metrics.memory_usage > 70 ? 'warning' : 'success'}">${metrics.memory_usage.toFixed(1)}MB</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Health Status</span>
                    <span class="metric-value ${metrics.health_status === 1 ? 'success' : 'danger'}">${metrics.health_status === 1 ? 'Healthy' : 'Unhealthy'}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Request Count</span>
                    <span class="metric-value">${metrics.request_count}</span>
                </div>
            `;

            // Update component status
            Object.entries(status).forEach(([component, health]) => {
                statusMetrics.innerHTML += `
                    <div class="metric">
                        <span class="metric-label">${component.replace('_', ' ').toUpperCase()}</span>
                        <span class="metric-value ${health === 'healthy' ? 'success' : 'danger'}">${health}</span>
                    </div>
                `;
            });
        }

        // Refresh incident history
        async function refreshIncidents() {
            const response = await fetch('/incidents');
            const incidents = await response.json();

            const incidentsDiv = document.getElementById('incidents');
            incidentsDiv.innerHTML = incidents.map(incident => `
                <div class="history-item ${incident.severity === 'critical' ? 'danger' : incident.severity === 'high' ? 'warning' : 'success'}">
                    <div class="history-timestamp">${new Date(incident.timestamp).toLocaleString()}</div>
                    <div>${incident.description}</div>
                    <div>Actions: ${incident.actions.join(', ')}</div>
                </div>
            `).join('');
        }

        // Refresh restart history
        async function refreshRestarts() {
            const response = await fetch('/restarts');
            const data = await response.json();

            const restartsDiv = document.getElementById('restarts');
            restartsDiv.innerHTML = `
                <div class="metric">
                    <span class="metric-label">Total Restarts</span>
                    <span class="metric-value">${data.total_restarts}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Successful Restarts</span>
                    <span class="metric-value success">${data.successful_restarts}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Failed Restarts Today</span>
                    <span class="metric-value ${data.failed_restarts_today > 0 ? 'danger' : 'success'}">${data.failed_restarts_today}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Max Failed Restarts Per Day</span>
                    <span class="metric-value">${data.max_failed_restarts_per_day}</span>
                </div>
            `;

            // Add restart history items
            data.restart_history.forEach(restart => {
                restartsDiv.innerHTML += `
                    <div class="history-item ${restart.successful ? 'success' : 'danger'}">
                        <div class="history-timestamp">${new Date(restart.timestamp).toLocaleString()}</div>
                        <div>Status: ${restart.successful ? 'Successful' : 'Failed'}</div>
                        <div>Reason: ${restart.reason}</div>
                    </div>
                `;
            });
        }

        // Initial load
        refreshMetrics();
        refreshIncidents();
        refreshRestarts();

        // Auto-refresh every 10 seconds
        setInterval(() => {
            refreshMetrics();
            refreshIncidents();
            refreshRestarts();
        }, 10000);
    </script>
</body>
</html>
